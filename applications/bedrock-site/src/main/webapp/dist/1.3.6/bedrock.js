"use strict";let Bedrock=Object.create(null);Bedrock.version="1.3.6";Bedrock.LogLevel=function(){let _=Object.create(null);_.TRACE=0;_.INFO=1;_.WARNNG=2;_.ERROR=3;let logLevel=_.ERROR;_.set=function(newLogLevel){logLevel=newLogLevel};let formatStrings=["TRC","INF","WRN","ERR"];_.say=function(messageLogLevel,message){if(messageLogLevel>=logLevel){console.log(formatStrings[messageLogLevel]+": "+message)}};return _}();Bedrock.Base=function(){let _=Object.create(null);_.new=function(parameters){return Object.create(this).init(parameters)};return _}();Bedrock.Utility=function(){let $=Object.create(null);$.copyIf=function(key,leftObject,rightObject){if(key in leftObject){rightObject[key]=leftObject[key]}};$.randomString=function(length,chars){let result="";for(let i=0;i<length;++i){result+=chars[Math.floor(Math.random()*chars.length)]}return result};return $}();Bedrock.Http=function(){let $=Object.create(null);$.get=function(queryString,onSuccess){let request=new XMLHttpRequest;request.overrideMimeType("application/json");request.open("GET",queryString,true);request.onload=function(event){if(request.status===200){let response=JSON.parse(this.responseText);onSuccess(response)}};request.send()};return $}();Bedrock.ServiceBase=function(){let $=Object.create(null);$.getQuery=function(parameters){let query="api";let divider="?";for(let name of Object.keys(parameters)){let parameter=parameters[name];query+=divider+name+"="+parameter;divider="&"}return query};$.getFromQuery=function(query,onSuccess){Bedrock.Http.get(query,function(response){console.log(query+" (status: "+response.status+")");if(response.status==="ok"){onSuccess(response.response)}})};$.get=function(parameters,onSuccess){$.getFromQuery($.getQuery(parameters),onSuccess)};return $}();Bedrock.ServiceDescriptor=function(){let $=Object.create(null);let valid=function(value=null){return value!==null};let block=function(block,attributes,content){let result="<"+block;if(valid(attributes)){let attributeNames=Object.keys(attributes);for(let attributeName of attributeNames){if(valid(attributes[attributeName])){result+=" "+attributeName+'="'+attributes[attributeName]+'"'}}}return result+(valid(content)?">"+content+"</"+block+">":"/>")};let div=function(cssClass,content){return block("div",{class:cssClass},content)};let a=function(cssClass,href,content){return block("a",{class:cssClass,href:href,target:"_top"},content)};$.get=function(queryString,onSuccess){let request=new XMLHttpRequest;request.overrideMimeType("application/json");request.open("GET",queryString,true);request.onload=function(event){if(request.status===200){let response=JSON.parse(this.responseText);onSuccess(response)}};request.send()};$.displaySpecification=function(specification){let innerHTML="";if("description"in specification){innerHTML+=block("h2",{},"Description")+div("description-div",specification.description)}if("events"in specification){innerHTML+=block("h2",{},"Events");let events=specification.events;let eventNames=Object.keys(events);let eventsHTML="";for(let eventName of eventNames){let event=events[eventName];let eventHTML="";if("example"in event){let url="api?event="+eventName;let example=event.example;let exampleKeys=Object.keys(example).sort();for(let exampleKey of exampleKeys){url+="&"+exampleKey+"="+example[exampleKey]}eventHTML=a("try-it",url,"[example]")}eventHTML=div("event-name",eventName+eventHTML);if("description"in event){eventHTML+=div("event-description",event.description)}let odd;let evenOdd=function(title,object){odd=true;let names=Object.keys(object);if(names.length>0){eventHTML+=div("even-odd-title",title);for(let name of names){let element=object[name];let required="required"in element?element.required:false;eventHTML+=div("even-odd-div"+(odd?" odd":""),div("even-odd-name",name)+div("even-odd-required",required?"REQUIRED":"OPTIONAL")+div("even-odd-description",element.description));odd=!odd}}return odd};if("parameters"in event){evenOdd("Parameters:",event.parameters)}if("strict"in event&&event.strict=="false"){eventHTML+=div("even-odd-div"+(odd?" odd":""),div("even-odd-name","(any)")+div("even-odd-required","OPTIONAL")+div("even-odd-description","Event allows unspecified parameters."))}if("returns"in event){let returns=event.returns;if(Array.isArray(returns)){if(returns.length>0){evenOdd("Returns Array of:",returns[0])}else{eventHTML+=div("even-odd-title","Returns: Array")}}else{evenOdd("Returns:",returns)}}eventsHTML+=div("event-div",eventHTML)}innerHTML+=div("events-div",eventsHTML)}if("name"in specification){document.title=specification.name;innerHTML=block("h1",{},specification.name)+div("container-div",innerHTML)}innerHTML+=div("content-center footer","Built with "+a("footer-link","http://bedrock.brettonw.com","Bedrock"));return innerHTML};const API_EVENT_HELP="api?event=help";$.display=function(displayInDivId,url=API_EVENT_HELP){$.get(url,function(response){response=response.response!==undefined?response.response:response;document.getElementById(displayInDivId).innerHTML=Bedrock.ServiceDescriptor.displaySpecification(response)})};let makeName=function(input){return input.replace(/-([^-])/g,function replacer(match,p1,offset,string){return p1.toUpperCase()})};$.translateResponse=function(response){let copyAsResponse=function(object){let copy={};let keys=Object.keys(object);for(let key of keys){copy[makeName(key)]=object[key]}return copy};if(Array.isArray(response)){let copy=[];for(let entry of response){copy.push(copyAsResponse(entry))}return copy}else{return copyAsResponse(response)}};$.api=function(onSuccess,baseUrl="",apiSource=""){baseUrl=baseUrl===""?location.href.substr(0,location.href.lastIndexOf("/")):baseUrl;baseUrl=baseUrl.replace(/\/$/g,"");let url=apiSource===""?baseUrl+"/"+API_EVENT_HELP:apiSource;$.get(url,function(response){response=response.response!==undefined?response.response:response;let api=Object.create(null);api.specification=response;if("events"in response){let events=response.events;let eventNames=Object.keys(events);for(let eventName of eventNames){let event=events[eventName];let functionName=makeName(eventName);let functionParameters="(";let functionBody='    let url = "'+baseUrl+"/api?event="+eventName+'";\n';let first=true;if("parameters"in event){let names=Object.keys(event.parameters);if(names.length>0){for(let name of names){let parameterName=makeName(name);functionParameters+=(first!==true?", ":"")+parameterName;functionBody+='    url += "'+name+'=" + '+parameterName+";\n";first=false}}}functionParameters+=(first!==true?", ":"")+"onSuccess";functionBody+="    Bedrock.ServiceDescriptor.get (url, function (response) {\n";functionBody+='        if (response.status === "ok") {\n';functionBody+="            response = Bedrock.ServiceDescriptor.translateResponse (response.response);\n";functionBody+="            onSuccess (response);\n";functionBody+="        }\n";functionBody+="    });\n";functionParameters+=")";console.log(functionName+" "+functionParameters+";\n");let functionString="return function "+functionParameters+" {\n"+functionBody+"};\n";api[functionName]=new Function(functionString)()}}onSuccess(api)})};return $}();let valid=function(value=null){return value!==null};let block=function(block,attributes,content){let result="<"+block;if(valid(attributes)){let attributeNames=Object.keys(attributes);for(let attributeName of attributeNames){if(valid(attributes[attributeName])){result+=" "+attributeName+'="'+attributes[attributeName]+'"'}}}return result+(valid(content)?">"+content+"</"+block+">":"/>")};let div=function(cssClass,content){return block("div",{class:cssClass},content)};Bedrock.Html=function(){let $=Object.create(null);$.removeAllChildren=function(element){while(element.firstChild){element.removeChild(element.firstChild)}};$.makeElement=function(tag,options){let element=document.createElement(tag);let optionNames=Object.keys(options);for(let optionName of optionNames){switch(optionName){case"class":case"classes":{let cssClasses=options[optionName];if(!Array.isArray(cssClasses)){cssClasses=cssClasses.split(",")}for(let cssClass of cssClasses){element.classList.add(cssClass)}break}case"style":{for(let style of Object.keys(options.style)){element.style[style]=options.style[style]}break}default:{element[optionName]=options[optionName];break}}}return element};$.addElement=function(parent,tag,options,before=null){let element=$.makeElement(tag,options);parent.insertBefore(element,before);return element};$.elementIsInView=function(element,view){let viewTop=view.scrollTop;let viewBottom=view.offsetHeight+viewTop;let elementTop=element.offsetTop;let elementBottom=elementTop+element.offsetHeight;return elementBottom<=viewBottom&&elementTop>=viewTop};$.getCssSelectorStyle=function(selector,style){for(let styleSheet of document.styleSheets){if(styleSheet.cssRules!==null){for(let cssRule of styleSheet.cssRules){if(cssRule.selectorText&&cssRule.selectorText===selector){return cssRule.style[style]}}}}return undefined};$.Builder=function(){let _=Object.create(Bedrock.Base);_.init=function(parameters){this.parentBuilder="parentBuilder"in parameters?parameters.parentBuilder:null;this.elementType=parameters.elementType;this.elementParameters=parameters.elementParameters!==undefined?parameters.elementParameters:{};this.builders=[];return this};_.addBuilder=function(builder){this.builders.push(builder);return this};_.add=function(elementType,elementParameters){return Object.is(this,_)?_.new({elementType:elementType,elementParameters:elementParameters}).build():this.addBuilder(_.new({parentBuilder:this,elementType:elementType,elementParameters:elementParameters}))};_.beginBuilder=function(builder){this.builders.push(builder);return builder};_.begin=function(elementType,elementParameters){return Object.is(this,_)?_.new({elementType:elementType,elementParameters:elementParameters}):this.beginBuilder(_.new({parentBuilder:this,elementType:elementType,elementParameters:elementParameters}))};_.end=function(){return this.parentBuilder!==null?this.parentBuilder:this.build()};_.build=function(){let element=$.makeElement(this.elementType,this.elementParameters);for(let builder of this.builders){element.appendChild(builder.build())}return element};return _}();return $}();Bedrock.ComboBox=function(){let _=Object.create(Bedrock.Base);let Html=Bedrock.Html;let Utility=Bedrock.Utility;let indexById={};_.getById=function(inputElementId){return indexById[inputElementId]};_.init=function(parameters){if("inputElementId"in parameters){let self=this;this.allowMouseover=true;this.useRegExp="useRegExp"in parameters?parameters.useRegExp:false;let inputElement,parentElement;let inputElementId="inputElementId"in parameters?parameters.inputElementId:"inputElement"in parameters?parameters.inputElement.id:null;if(inputElementId!=null){inputElement="inputElement"in parameters?parameters.inputElement:document.getElementById(inputElementId);if(inputElement==null){let parentElementId="parentElementId"in parameters?parameters.parentElementId:"parentElement"in parameters?parameters.parentElement.id:null;if(parentElementId!=null){parentElement="parentElement"in parameters?parameters.parentElement:document.getElementById(parentElementId);let inputElementParameters={classes:["combobox-input"],id:inputElementId,placeholder:inputElementId,type:"text"};if("class"in parameters){inputElementParameters.classes.push(parameters.class)}Utility.copyIf("placeholder",parameters,inputElementParameters);Utility.copyIf("style",parameters,inputElementParameters);Utility.copyIf("onchange",parameters,inputElementParameters);inputElement=Html.addElement(parentElement,"input",inputElementParameters)}else{console.log("ERROR: expected 'parentElementId' or 'parentElement'.");return null}}else{parentElement=inputElement.parentNode}}else{console.log("ERROR: expected 'inputElementId' or 'inputElement'.");return null}this.inputElement=inputElement;if("value"in parameters){this.inputElement.value=parameters.value}let pseudoParentElement=Html.addElement(parentElement,"div",{class:"combobox-pseudo-parent"},inputElement.nextSibling);let optionsElement=this.optionsElement=Html.addElement(pseudoParentElement,"div",{id:inputElementId+"-options",class:"combobox-options"});this.setOptions(parameters.options);{inputElement.onmousedown=function(event){let x=(event.pageX-this.offsetLeft)/this.offsetWidth;let arrowPlacement=(this.offsetWidth-parseFloat(getComputedStyle(this).backgroundSize))/this.offsetWidth;if(x>arrowPlacement){inputElement.value="";if(this===document.activeElement){self.updateOptions()}self.callOnChange()}};inputElement.onkeydown=function(event){switch(event.key){case"ArrowUp":{if(self.currentOption!=null){self.currentOption.classList.remove("combobox-option-hover");if(self.currentOption.previousSibling!=null){self.currentOption=self.currentOption.previousSibling}else{self.currentOption=optionsElement.lastChild}}else{self.currentOption=optionsElement.lastChild}self.currentOption.classList.add("combobox-option-hover");if(!Html.elementIsInView(self.currentOption,optionsElement)){self.allowMouseover=false;optionsElement.scrollTop=self.currentOption.offsetTop}break}case"ArrowDown":{if(self.currentOption!=null){self.currentOption.classList.remove("combobox-option-hover");if(self.currentOption.nextSibling!=null){self.currentOption=self.currentOption.nextSibling}else{self.currentOption=optionsElement.firstChild}}else{self.currentOption=optionsElement.firstChild}self.currentOption.classList.add("combobox-option-hover");if(!Html.elementIsInView(self.currentOption,optionsElement)){self.allowMouseover=false;optionsElement.scrollTop=self.currentOption.offsetTop-optionsElement.offsetHeight+self.currentOption.offsetHeight}break}case"Enter":{if(self.currentOption!=null){inputElement.value=self.currentOption.getAttribute("data-value")}self.callOnChange();inputElement.blur();break}case"Escape":{inputElement.blur();break}default:return true}return false};inputElement.onpaste=function(){this.oninput()};inputElement.oninput=function(){self.updateOptions();self.callOnChange()};inputElement.onfocus=function(event){self.updateOptions();optionsElement.scrollTop=0;optionsElement.style.display="block"};inputElement.onblur=function(){self.optionsElement.style.display="none"}}}else{console.log("ERROR: 'inputElementId' is required.");return null}return this};_.callOnChange=function(){if("onchange"in this.inputElement&&typeof this.inputElement.onchange==="function"){this.inputElement.onchange()}};_.updateOptions=function(){let self=this;self.currentOption=null;let inputElement=this.inputElement;let optionsElement=this.optionsElement;while(optionsElement.firstChild){optionsElement.removeChild(optionsElement.firstChild)}let fragment=document.createDocumentFragment();let inputElementValue=this.useRegExp?this.inputElement.value:this.inputElement.value.replace(/[\-\[\]{}()*+?.,\\\^$|#\s]/g,"\\$&");let regExp=new RegExp(inputElementValue,"i");for(let option of this.options){if(option.matchTarget.match(regExp)){let comboBoxOption=Html.addElement(fragment,"div",{class:"combobox-option",onmousedown:function(){inputElement.value=option.value;self.callOnChange();return true},onmouseover:function(){if(self.allowMouseover===true){if(self.currentOption!=null){self.currentOption.classList.remove("combobox-option-hover")}self.currentOption=this;this.classList.add("combobox-option-hover")}self.allowMouseover=true},onmouseout:function(){if(self.allowMouseover===true){this.classList.remove("combobox-option-hover")}}});comboBoxOption.setAttribute("data-value",option.value);let display=option.value.length>32?option.value.substr(0,30)+"...":option.value;if("label"in option){Html.addElement(comboBoxOption,"div",{style:{float:"left"}}).innerHTML=display;Html.addElement(comboBoxOption,"div",{class:"combobox-option-label"}).innerHTML=option.label}else{comboBoxOption.innerHTML=display}}}optionsElement.appendChild(fragment);return this};_.setOptions=function(options){this.options=options;let conditionedOptions=this.options=[];for(let option of options){if(option===Object(option)){let conditionedOption={value:option.value,matchTarget:option.value};if("label"in option){conditionedOption.label=option.label;conditionedOption.matchTarget+=", "+option.label}if("alt"in option){conditionedOption.matchTarget+=", "+option.alt}conditionedOptions.push(conditionedOption)}else{conditionedOptions.push({value:option,matchTarget:option})}}this.currentOption=null;return this};Object.defineProperty(_,"value",{get:function(){return this.inputElement.value},set:function(value){this.inputElement.value=value}});Object.defineProperty(_,"onchange",{set:function(onchange){this.inputElement.onchange=onchange}});return _}();Bedrock.PagedDisplay=function(){let $=Object.create(null);let Html=Bedrock.Html;$.Select=function(){let _=Object.create(Bedrock.Base);_.init=function(parameters){this.name=parameters.name};return _};$.getAllFieldNames=function(records){let fields=Object.create(null);for(let record of records){let keys=Object.keys(record);for(let key of keys){fields[key]=key}}return Object.keys(fields).sort()};$.makeTable=function(container,records,fieldNames=$.getAllFieldNames(records)){let recordCount=records.length;const displayLineSize=parseInt(Html.getCssSelectorStyle(".bedrock-database-line","height"));const pageSize=Math.floor(container.offsetHeight/displayLineSize*1.25);const pageHeight=displayLineSize*pageSize;const pageCount=Math.floor(recordCount/pageSize)+(recordCount%pageSize>0?1:0);Html.removeAllChildren(container);container.scrollTop=0;let pageIsVisible=function(page,view){let pageInfo=page.id.split(/-/);let start=parseInt(pageInfo[1])*displayLineSize-view.scrollTop;let end=parseInt(pageInfo[2])*displayLineSize-view.scrollTop;return end>=0&&start<=view.clientHeight};let lastVisiblePages=[];container.onscroll=function(){let visiblePages=[];for(let page of lastVisiblePages){if(pageIsVisible(page,container)){visiblePages.push(page)}else{Html.removeAllChildren(page)}}let start=Math.floor(container.scrollTop/pageHeight);let end=Math.min(pageCount,start+2);let pages=container.children[0].children;for(let i=start;i<end;++i){let page=pages[i];if(page.children.length===0&&pageIsVisible(page,container)){visiblePages.push(page);populatePage(page)}}lastVisiblePages=visiblePages};let populatePage=function(pageElement){let pageBuilder=Html.Builder.begin("div");let pageInfo=pageElement.id.split(/-/);let start=parseInt(pageInfo[1]);let end=parseInt(pageInfo[2]);for(let j=start;j<end;++j){try{let record=records[j];let lineBuilder=pageBuilder.begin("div",{class:(j&1)===1?["bedrock-database-line","odd"]:["bedrock-database-line"]});for(let fieldName of fieldNames){let value=fieldName in record?record[fieldName]:"";let styleName=fieldName.replace(/ /g,"-").toLowerCase();lineBuilder.begin("div",{class:"bedrock-database-entry"}).add("div",{class:[styleName,"bedrock-database-entry-text"],innerHTML:value}).end()}pageBuilder.end()}catch(exception){console.log(exception)}}pageElement.appendChild(pageBuilder.end())};let pageContainerBuilder=Html.Builder.begin("div");for(let pageIndex=0;pageIndex<pageCount;++pageIndex){let start=pageIndex*pageSize;let end=Math.min(start+pageSize,recordCount);pageContainerBuilder.add("div",{id:"page-"+start+"-"+end,style:{height:(end-start)*displayLineSize+"px"}})}container.appendChild(pageContainerBuilder.end());container.onscroll(null);return container};$.makeTableHeader=function(container,fieldNames){let headerBuilder=Html.Builder.begin("div",{class:"bedrock-header-line"});for(let fieldName of fieldNames){let styleName=fieldName.replace(/ /g,"-").toLowerCase();headerBuilder.begin("div",{class:"bedrock-header-entry"}).add("div",{class:[styleName,"bedrock-header-entry-text"],innerHTML:fieldName}).end()}container.appendChild(headerBuilder.end())};$.makeTableWithHeader=function(container,records,fieldNames=$.getAllFieldNames(records)){Html.removeAllChildren(container);$.makeTableHeader(container,fieldNames);let listContainer=Html.addElement(container,"div",{class:"bedrock-database-display-list"});return $.makeTable(listContainer,records,fieldNames)};return $}();Bedrock.Forms=function(){let _=Object.create(Bedrock.Base);let Html=Bedrock.Html;const INPUT="-input-";const ERROR="-error-";_.LIST="list";_.SELECT="select";_.TEXT="text";_.CHECKBOX="checkbox";_.init=function(parameters){let scope=this;let formName=this.name=parameters.name;this.completion=parameters.completion;let onUpdate=function(updatedName){if("onUpdate"in parameters){parameters.onUpdate(updatedName,scope)}};let divElement=document.getElementById(parameters.div);divElement=Html.addElement(divElement,"div",{class:"form-container"});let inputs=this.inputs={};for(let input of parameters.inputs){let formDivElement=Html.addElement(divElement,"div",{class:"form-div"});Html.addElement(formDivElement,"div",{class:"form-title-div",innerHTML:input.label});let parentDiv=Html.addElement(formDivElement,"div",{class:"form-input-div"});let inputObject=inputs[input.name]={name:input.name,type:input.type,required:"required"in input?input.required:false};let inputElementId=formName+"-"+Bedrock.Utility.randomString(8,"0123456789ABCDEF")+INPUT+input.name;switch(input.type){case _.TEXT:{let value="value"in input?input.value:"";inputObject.inputElement=Html.addElement(parentDiv,"input",{id:inputElementId,type:_.TEXT,class:"form-input",placeholder:input.placeholder,value:value,onchange:function(){onUpdate(input.name)}});inputObject.value=value;if("pattern"in input){inputObject.pattern=input.pattern}break}case _.CHECKBOX:{let checked="checked"in input?input.checked:false;inputObject.inputElement=Html.addElement(parentDiv,"input",{id:inputElementId,type:_.CHECKBOX,class:"form-input",checked:checked,onchange:function(){onUpdate(input.name)}});inputObject.checked=checked;break}case _.SELECT:{let inputElement=inputObject.inputElement=Html.addElement(parentDiv,_.SELECT,{id:inputElementId,class:"form-input",onchange:function(){onUpdate(input.name)}});for(let option of input.options){let value=option===Object(option)?option.value:option;let label=option===Object(option)&&"label"in option?option.label:value;Html.addElement(inputElement,"option",{value:value,innerHTML:label})}let value="value"in input?input.value:inputObject.inputElement.value;inputObject.inputElement.value=inputObject.value=value;break}case _.LIST:{let value="value"in input?input.value:"";inputObject.inputElement=Bedrock.ComboBox.new({class:"form-input",parentElement:parentDiv,placeholder:input.placeholder,inputElementId:inputElementId,options:input.options,value:value,onchange:function(){onUpdate(input.name)}});inputObject.value=value;if("pattern"in input){inputObject.pattern=input.pattern}break}}inputObject.errorElement=Html.addElement(formDivElement,"div",{id:formName+"-"+Bedrock.Utility.randomString(8,"0123456789ABCDEF")+ERROR+input.name,class:"form-error",innerHTML:inputObject.required?"REQUIRED":""})}let formDivElement=Html.addElement(divElement,"div",{classes:["form-div","form-button-wrapper"]});Html.addElement(formDivElement,"input",{type:"button",value:"SUBMIT",class:"form-submit-button",onclick:function(){scope.handleClickSubmit()}});return this};_.handleClickSubmit=function(){let allValid=true;let inputNames=Object.keys(this.inputs);for(let inputName of inputNames){let input=this.inputs[inputName];if(input.required){let valid=true;switch(input.type){case _.TEXT:case _.SELECT:case _.LIST:{if("pattern"in input){valid=input.inputElement.value.match(input.pattern)!==null}else{valid=input.inputElement.value.length>0}break}case _.CHECKBOX:{valid=input.inputElement.checked;break}}input.errorElement.style.visibility=valid?"hidden":"visible";allValid=allValid&&valid}}if(allValid===true){this.completion(this)}};_.reset=function(){let inputNames=Object.keys(this.inputs);for(let inputName of inputNames){let input=this.inputs[inputName];switch(input.type){case _.CHECKBOX:input.inputElement.checked=input.checked;break;case _.TEXT:case _.SELECT:case _.LIST:input.inputElement.value=input.value;break}}};_.getValues=function(){let result={event:this.name};let keys=Object.keys(this.inputs);for(let key of keys){let input=this.inputs[key];switch(input.type){case _.CHECKBOX:result[input.name]=input.inputElement.checked;break;case _.TEXT:case _.SELECT:case _.LIST:result[input.name]=input.inputElement.value;break}}return result};_.setValues=function(values){let keys=Object.keys(this.inputs);for(let key of keys){if(key in values){let input=this.inputs[key];switch(input.type){case _.CHECKBOX:input.inputElement.checked=values[key];break;case _.TEXT:case _.SELECT:case _.LIST:input.inputElement.value=values[key];break}}}};return _}();Bedrock.CompareFunctions=function(){let $=Object.create(null);$.NUMERIC="numeric";$.ALPHABETIC="alphabetic";$.CHRONOLOGIC="chronologic";$.AUTO="auto";$.WILDCARD="*";let compareNumeric=function(a,b,asc){return asc?a-b:b-a};$.numeric=function(a=null,b=null,asc){if(a===null){return b!==null?asc?-1:1:0}if(b===null){return asc?1:-1}return compareNumeric(a,b,asc)};let compareAlphabetic=function(a,b,asc){let ra=a.replace(/\s*/g,"").toLowerCase();let rb=b.replace(/\s*/g,"").toLowerCase();return asc?ra.localeCompare(rb):rb.localeCompare(ra)};$.alphabetic=function(a=null,b=null,asc){if(a===null){return b!==null?asc?-1:1:0}if(b===null){return asc?1:-1}return compareAlphabetic(a,b,asc)};$.date=function(a=null,b=null,asc){if(a===null){return b!==null?asc?-1:1:0}if(b===null){return asc?1:-1}return compareNumeric(new Date(a).valueOf(),new Date(b).valueOf())};$.auto=function(a=null,b=null,asc){if(a===null){return b!==null?asc?-1:1:0}if(b===null){return asc?1:-1}let na=Number(a),nb=Number(b);if(na==a.toString()&&nb==b.toString()){return compareNumeric(na,nb,asc)}return compareAlphabetic(a,b,asc)};$.get=function(type=$.AUTO){switch(type.toLowerCase()){case $.NUMERIC:case"number":case"digits":return this.numeric;case $.ALPHABETIC:case"text":case"string":return this.alphabetic;case $.CHRONOLOGIC:case"date":case"timestamp":return this.date;case $.AUTO:case"any":case $.WILDCARD:default:return this.auto}throw"Unknown type ("+type+")"};$.compare=function(a,b,asc,type){return this.get(type)(a,b,asc)};$.mask=function(compareResult){return compareResult<0?1:compareResult>0?4:2};$.operationMask=function(operation){switch(operation.toLowerCase()){case"lt":case"<":return 1;case"lte":case"<=":return 3;case"eq":case"=":case"==":return 2;case"gte":case">=":return 6;case"gt":case">":return 4;case"ne":case"neq":case"<>":case"!=":case"!":return 5}throw"Unknown operation ("+operation+")"};return $}();Bedrock.Comparable=function(){let $=Object.create(null);$.FieldComparable=function(){let _=Object.create(Bedrock.Base);_.init=function(parameters){this.compareFunction=Bedrock.CompareFunctions.get(parameters.type);this.ascending="ascending"in parameters?parameters.ascending:true;this.ascending="descending"in parameters?!parameters.descending:this.ascending;this.name=parameters.name;return this};_.compare=function(recordA,recordB){return this.compareFunction(recordA[this.name],recordB[this.name],this.ascending)};return _}();$.RecordComparable=function(){let _=Object.create(Bedrock.Base);_.init=function(parameters){let fc=this.fieldComparables=[];for(let field of parameters.fields){fc.push(Bedrock.Comparable.FieldComparable.new(field))}return this};_.compare=function(recordA,recordB){for(let fieldComparable of this.fieldComparables){let sortResult=fieldComparable.compare(recordA,recordB);if(sortResult!=0){return sortResult}}return 0};return _}();return $}();Bedrock.DatabaseOperations=function(){let $=Object.create(null);let CompareFunctions=Bedrock.CompareFunctions;let maskFunction=CompareFunctions.mask;$.Filter=function(){let _=Object.create(Bedrock.Base);_.init=function(parameters){return this};_.perform=function(database){return database};return _}();$.Match=function(){let _=Object.create(Bedrock.Base);_.init=function(parameters){this.field=parameters.field;let invert="invert"in parameters?parameters.invert:false;this.shouldMatch=!parameters.invert;try{this.regExp=new RegExp(parameters.match,"i")}catch(error){this.regExp=new RegExp(parameters.match.replace(/[\-\[\]{}()*+?.,\\\^$\|#\s]/g,"\\$&"),"i")}return this};_.perform=function(database){let result=[];let field=this.field;let regExp=this.regExp;let shouldMatch=this.shouldMatch;let matchValue=function(value){let matchResult=value.toString().match(regExp);return matchResult!=null===true};for(let record of database){let match=field in record;if(match===true){let values=record[field];if(values instanceof Array){match=false;for(let value of values){match=match||matchValue(value)}}else{match=matchValue(values)}}if(match===shouldMatch){result.push(record)}}return result};return _}();$.Compare=function(){let _=Object.create(Bedrock.Base);_.init=function(parameters){this.field=parameters.field;this.operationMask=CompareFunctions.operationMask("operation"in parameters?parameters.operation:"=");this.compareFunction=CompareFunctions.get("type"in parameters?parameters.type:"auto");this.value=parameters.value;return this};_.perform=function(database){let result=[];let field=this.field;let operationMask=this.operationMask;let compareFunction=this.compareFunction;let value=this.value;for(let record of database){if(field in record){let compareResult=compareFunction(record[field],value);let maskedCompareResult=mask(compareResult);if((maskedCompareResult&operationMask)!=0){result.push(record)}}}return result};return _}();$.CompareSorted=function(){let _=Object.create(Bedrock.Base);_.init=function(parameters){this.field=parameters.field;this.operationMask=CompareFunctions.operationMask("operation"in parameters?parameters.operation:"=");this.compareFunction=CompareFunctions.get("type"in parameters?parameters.type:"auto");this.value=parameters.value;return this};_.perform=function(database){let field=this.field;let operationMask=this.operationMask;let compareFunction=this.compareFunction;let value=this.value;let end=database.length;let findLowerBound=function(low,high){while(low<=high){let mid=low+high>>>1;let cmp=mid<end?compareFunction(database[mid][field],value,true):1;if(cmp<0){low=mid+1}else{high=mid-1}}return low};let findUpperBound=function(low,high){while(low<=high){let mid=low+high>>>1;let cmp=mid<end?compareFunction(database[mid][field],value,true):1;if(cmp<=0){low=mid+1}else{high=mid-1}}return low};let upperBound;switch(operationMask){case 1:return database.slice(0,findLowerBound(0,end));case 3:return database.slice(0,findUpperBound(0,end));case 2:upperBound=findUpperBound(0,end);return database.slice(findLowerBound(0,upperBound),upperBound);case 6:return database.slice(findLowerBound(0,end));case 4:return database.slice(findUpperBound(0,end));case 5:upperBound=findUpperBound(0,end);return database.slice(0,findLowerBound(0,upperBound)).concat(database.slice(upperBound))}return result};return _}();$.And=function(){let _=Object.create(Bedrock.Base);_.init=function(parameters){this.filters=parameters.filters;return this};_.perform=function(database){for(let filter of this.filters){database=filter.perform(database)}return database};return _}();$.Or=function(){let _=Object.create(Bedrock.Base);_.init=function(parameters){this.filters=parameters.filters;this.field=parameters.field;return this};_.perform=function(database){let resultKey={};let result=[];let field=this.field;for(let filter of this.filters){let filteredDatabase=filter.perform(database);for(let record of filteredDatabase){if(field in record){let key=record[field];if(!(key in resultKey)){resultKey[key]=key;result.push(record)}}}}return result};return _}();$.Sort=function(){let _=Object.create(Bedrock.Base);_.init=function(parameters){this.recordComparable=Bedrock.Comparable.RecordComparable.new(parameters);return this};_.perform=function(database){let newDatabase=database.slice();let that=this;newDatabase.sort(function(recordA,recordB){return that.recordComparable.compare(recordA,recordB)});return newDatabase};return _}();$.Range=function(){let _=Object.create(Bedrock.Base);_.init=function(parameters){this.field=parameters.field;this.type=parameters.type;this.min=parameters.min;this.max=parameters.max;let sort=$.Sort.new({fields:[{name:parameters.field,type:parameters.type}]});let min=$.CompareSorted.new({field:parameters.field,operation:"gte",type:parameters.type,value:parameters.min});let max=$.CompareSorted.new({field:parameters.field,operation:"lte",type:parameters.type,value:parameters.max});let and=$.And.new({filters:[sort,min,max]});this.filter=and;return this};_.perform=function(database){return this.filter.perform(database)};return _}();$.Select=function(){let _=Object.create(Bedrock.Base);_.init=function(parameters){return this};_.perform=function(database){return database};return _}();return $}();Bedrock.Database=function(){let $=Object.create(null);let Html=Bedrock.Html;$.getAllFields=function(database){let allFields={};for(let record of database){let fields=Object.keys(record).sort();for(let field of fields){if(!(field in allFields)){allFields[field]=Object.create(null)}let values=record[field];if(values instanceof Array){for(let value of values){allFields[field][value]=value}}else{allFields[field][values]=values}}}let fields=Object.keys(allFields);for(let field of fields){allFields[field]=Object.keys(allFields[field]).sort()}return allFields};$.Source=function(){let _=Object.create(Bedrock.Base);_.init=function(database){this.database=database;return this};_.getDatabase=function(){return this.database};return _}();$.FilterElement=function(){let _=Object.create(Bedrock.Base);let doFilter=function(database,filterField,filterValue,shouldMatch=true){let result=[];if(filterField.length===0){return database}let regExp;try{regExp=new RegExp(filterValue,"i")}catch(error){regExp=new RegExp(filterValue.replace(/[\-\[\]{}()*+?.,\\\^$|#\s]/g,"\\$&"),"i")}let matchValue=function(value){let matchResult=value.toString().match(regExp);return matchResult!=null===shouldMatch};for(let record of database){let match=filterField in record;if(match===true){let values=record[filterField];if(values instanceof Array){let anyMatches=false;for(let value of values){anyMatches=anyMatches||matchValue(value)}match=match&&anyMatches}else{match=match&&matchValue(values)}}if(match===true){result.push(record)}}return result};const FILTER_ELEMENT_FIELD="filter-element-field";const FILTER_ELEMENT_VALUE="filter-element-value";_.init=function(parameters){let scope=this;let index=this.index=parameters.index;this.databaseSource=parameters.databaseSource;this.owner=parameters.owner;let filterField=parameters.initialValue.field;let filterValue=parameters.initialValue.value;let fieldKeys=parameters.fieldKeys;this.elementContainer=Html.addElement(parameters.div,"div",{class:"bedrock-database-element-container",id:"filterElementContainer"+index});this.countDiv=Html.addElement(this.elementContainer,"div",{class:"bedrock-database-element-text-div"});let fieldComboBox=this.fieldComboBox=Bedrock.ComboBox.new({style:{width:"100%"},parentElementId:this.elementContainer.id,placeholder:"(FILTER FIELD)",inputElementId:FILTER_ELEMENT_FIELD+index,options:fieldKeys,value:filterField,onchange:function(){scope.valueComboBox.value="";scope.update()}});let database=this.databaseSource.getDatabase();let allFields=$.getAllFields(database);let valueComboBox=this.valueComboBox=Bedrock.ComboBox.new({style:{width:"100%"},parentElementId:this.elementContainer.id,placeholder:"(FILTER VALUE)",inputElementId:FILTER_ELEMENT_VALUE+index,options:filterField in allFields?allFields[filterField]:[],value:filterValue,onchange:function(){scope.finishUpdate()}});this.filteredDatabase=doFilter(database,filterField,filterValue,true);this.countDiv.innerHTML=this.filteredDatabase.length+"/"+database.length;return this};_.update=function(){let database=this.databaseSource.getDatabase();let allFields=$.getAllFields(database);this.valueComboBox.setOptions(this.fieldComboBox.value in allFields?allFields[this.fieldComboBox.value]:[]);this.finishUpdate()};_.finishUpdate=function(){let database=this.databaseSource.getDatabase();this.filteredDatabase=doFilter(database,this.fieldComboBox.value,this.valueComboBox.value,true);this.countDiv.innerHTML=this.filteredDatabase.length+"/"+database.length;this.owner.push(this.index)};_.onValueChange=function(updatedControl){this.update()};_.getDatabase=function(){return this.filteredDatabase};_.setFieldValue=function(filterField,filterValue){this.fieldComboBox.value=filterField;let database=this.databaseSource.getDatabase();let allFields=$.getAllFields(database);this.valueComboBox.setOptions(this.fieldComboBox.value in allFields?allFields[this.fieldComboBox.value]:[]).value=filterValue};return _}();$.SortElement=function(){let _=Object.create(Bedrock.Base);let makeControls=function(index,field,type,asc,fieldKeys){let innerHTML=div("bedrock-element-div",makeSelectHTML("sortElementSelectKey"+index,fieldKeys,field,"SORT FIELD"))+div("bedrock-element-div",makeSelectHTML("sortElementSelectType"+index,["AUTO","NUMERIC","ALPHABETIC","DATE"],type,"SORT TYPE"))+div("bedrock-element-div",makeSelectHTML("sortElementSelectAsc"+index,["ASCENDING","DESCENDING"],asc,"SORT ASC"));return innerHTML};_.init=function(parameters){this.index=parameters.index;this.owner=parameters.owner;this.sortField=parameters.sortField;this.sortType=parameters.sortType;this.sortAsc=parameters.sortAsc;document.getElementById("sortElementContainer"+parameters.index).innerHTML=makeControls(parameters.index,this.sortField,this.sortType,this.sortAsc,parameters.fieldKeys);return this};return _}();$.Filter=function(){let _=Object.create(Bedrock.Base);let conditionValues=function(values=[],elementCount=0){for(let i=values.length;i<elementCount;++i){values.push({})}for(let value of values){value.field="field"in value?value.field:"";value.value="value"in value?value.value:""}return values};_.init=function(parameters){this.databaseSource=parameters.databaseSource;this.elementCount=parameters.elementCount;this.owner=parameters.owner;this.fieldKeys=parameters.fieldKeys;this.initialValues=conditionValues(parameters.initialValues,parameters.elementCount);return this.reset()};_.finish=function(){let filters=this.filters;let length=filters.length;let index=length-1;while(filters[index].fieldComboBox.value.length==0&&index>0){--index}if(filters[index].fieldComboBox.value.length>0){++index}if(index<length){filters[index].elementContainer.style.display="inline-block";while(++index<length){filters[index].elementContainer.style.display="none"}}this.owner.push(this.getDatabase())};_.push=function(index){let filters=this.filters;let length=filters.length;if(index+1<length){filters[index+1].update()}else{this.finish()}return this};_.update=function(){return this.push(-1)};_.onValueChange=function(updatedControl){let index=updatedControl.id.match(/\d+$/)[0];this.filters[index].onValueChange(updatedControl)};_.getDatabase=function(){return this.filters[this.filters.length-1].getDatabase()};_.setValues=function(values){let elementCount=this.elementCount;let filters=this.filters;values=conditionValues(values,elementCount);for(let i=0;i<elementCount;++i){filters[i].setFieldValue(values[i].field,values[i].value)}return this.update()};_.reset=function(){let scope=this;let filterContainer=document.getElementById("filterContainer");while(filterContainer.firstChild){filterContainer.removeChild(filterContainer.firstChild)}this.filters=[];for(let index=0;index<this.elementCount;++index){this.filters.push($.FilterElement.new({div:filterContainer,index:index,fieldKeys:this.fieldKeys,initialValue:this.initialValues[index],databaseSource:index>0?this.filters[index-1]:this.databaseSource,owner:this}))}let clearButtonElementContainer=Html.addElement(filterContainer,"div",{class:"bedrock-database-element-container"});Html.addElement(clearButtonElementContainer,"div",{class:"bedrock-database-element-text-div"});Html.addElement(clearButtonElementContainer,"button",{class:"bedrock-database-clear-button",onclick:function(){scope.reset()}}).innerHTML="CLEAR";this.finish();return this};return _}();$.Sort=function(){let _=Object.create(Bedrock.Base);_.init=function(parameters){this.elementCount=parameters.elementCount;this.owner=parameters.owner;this.fieldKeys=parameters.fieldKeys;let sortContainerHTML="";for(let index=0;index<this.elementCount;++index){sortContainerHTML+=block("div",{class:"bedrock-database-element-container",id:"sortElementContainer"+index},"")}sortContainerHTML+=div("bedrock-database-element-container",div("bedrock-database-element-text-div","")+div("bedrock-element-div",block("button",{class:"bedrockClearButton",type:"button",onclick:"theBedrock.sort.reset ();"},"CLEAR")));document.getElementById("sortContainer").innerHTML=sortContainerHTML;this.sorts=[];for(let index=0;index<this.elementCount;++index){this.sorts.push($.SortElement.new({index:index,fieldKeys:this.fieldKeys,owner:this,sortField:"",sortType:"",sortAsc:""}))}return this};return _}();$.Container=function(){let _=Object.create(Bedrock.Base);_.init=function(parameters){this.databaseSource=$.Source.new(parameters.database);this.fieldKeys=Object.keys($.getAllFields(parameters.database)).sort();this.onUpdate=parameters.onUpdate;let bedrockContainerId="div"in parameters?parameters.div:"bedrock-database-container";let bedrockContainer=document.getElementById(bedrockContainerId);Html.addElement(bedrockContainer,"div",{class:"bedrock-database-group-container",id:"filterContainer"});Html.addElement(bedrockContainer,"div",{class:"bedrock-database-group-container",id:"sortContainer"});this.filter=$.Filter.new({databaseSource:this.databaseSource,fieldKeys:this.fieldKeys,owner:this,elementCount:parameters.filterElementCount!==undefined?parameters.filterElementCount:4,initialValues:parameters.filterValues});return this};_.push=function(db){this.onUpdate(db)};return _}();return $}();